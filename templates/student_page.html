<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Learning Portal</title>
    <!-- Audio for button click sound -->
    <audio id="buttonClickSound" src="{{ url_for('static', filename='audio/ButtonClickSound.mp3') }}" preload="auto"></audio>
    <!-- Background music -->
    <audio id="backgroundMusic" loop>
        <source src="{{ url_for('static', filename='audio/StudentPageBGM.mp3') }}" type="audio/mp3">
    </audio>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='student_page.css') }}">
</head>
<body>
    <header>
        <h1>Fun Learning World !!!</h1>
        <button id="logoutButton" onclick="logoutAndPlaySound()" title="Logout">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </header>
    <div class="container">
        <!-- Topics Navigation -->
        <div class="topics-nav">
            <h2>Topics</h2>
            <div id="topics-list" class="topics-list"></div>
            <!-- Inside the topics-nav div (below the topics list) -->
            <div class="tip-message">
                <i class="fas fa-info-circle"></i>The "Start Exercises" button is below the videoðŸ˜Š Enjoy!
            </div>

            <!-- New: Teacher Filter & Search Bar -->
            <div class="filter-section">
                <label for="teacher-filter">Filter by Teacher:</label>
                <select id="teacher-filter">
                    <option value="">All Teachers</option>
                </select>
            </div>
            <div class="search-section">
                <input type="text" id="search-input" placeholder="Search videos or exercises...">
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Video Section -->
            <div id="video-section" class="section">
                <h2 id="current-topic-title">Select a Topic</h2>
                <div id="teacher-info" class="teacher-info"></div>
                <div id="video-status" class="status-message"></div>
                <div id="video-container" class="video-container"></div>
            </div>

            <!-- Exercise Section -->
            <div id="exercise-section" class="section hidden">
                <button onclick="backToVideos(); playClickSound()" class="back-btn">
                    <i class="fas fa-arrow-left"></i> Back to Videos
                </button>
                <h2 id="exercise-topic-title"></h2>
                <div id="exercise-teacher-info" class="teacher-info"></div>
                <div id="exercise-status" class="status-message"></div>
                <div id="exercise-progress">
                    <span id="completed-count">0</span> out of <span id="total-count">0</span> exercises completed
                </div>
                <div id="current-exercise" class="exercise-container">
                    <!-- Exercise will be loaded here -->
                </div>
                <div id="feedback-message" class="feedback-message"></div>
                <button id="next-exercise-btn" class="hidden" onclick="loadNextExercise(); playClickSound()">
                    Next Exercise <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Music Control Button -->
    <div class="music-control">
        <button id="musicToggle" title="Toggle Background Music">
            <i class="fas fa-music"></i>
        </button>
    </div>

    <script>
        // Feedback messages
        const positiveFeedback = [
            "Correct!", "Great!", "Good Job!", "Awesome!",
            "Bravo!", "Keep it up!", "Fantastic!", "Smart!", "Excellent!"
        ];
        const negativeFeedback = [
            "Let's try again!"
        ];

        let currentTopicIndex = 0;
        let exercises = [];
        let currentExerciseIndex = 0;
        let completedExercises = [];
        let musicEnabled = false;
        let allVideos = [];
        let allExercises = [];

        const backgroundMusic = document.getElementById("backgroundMusic");

        // Initialize the page
        document.addEventListener("DOMContentLoaded", () => {
            loadTopics();
            setupMusicControls();
            loadTeachers();
        });

        // Set up music controls
        function setupMusicControls() {
            const musicToggle = document.getElementById("musicToggle");
            if (localStorage.getItem('musicEnabled') === 'true') {
                musicEnabled = true;
                backgroundMusic.play().catch(e => console.log("Autoplay prevented:", e));
                musicToggle.innerHTML = '<i class="fas fa-volume-up"></i>';
            }
            musicToggle.addEventListener("click", () => {
                playClickSound();
                musicEnabled = !musicEnabled;
                if (musicEnabled) {
                    backgroundMusic.play().catch(e => console.log("Play prevented:", e));
                    musicToggle.innerHTML = '<i class="fas fa-volume-up"></i>';
                    localStorage.setItem('musicEnabled', 'true');
                } else {
                    backgroundMusic.pause();
                    musicToggle.innerHTML = '<i class="fas fa-volume-mute"></i>';
                    localStorage.setItem('musicEnabled', 'false');
                }
            });
        }

        // Load all available topics
        function loadTopics() {
            const topicsList = document.getElementById("topics-list");
            topicsList.innerHTML = "";
            const topicNames = [
                "Numbers Up To 100",
                "Addition and Subtraction",
                "Fractions",
                "Money",
                "Time",
                "Length, Mass and Volume of Liquid",
                "Shapes",
                "Data"
            ];
            for (let i = 0; i < topicNames.length; i++) {
                const topicBtn = document.createElement("button");
                topicBtn.textContent = `Topic ${i + 1}: ${topicNames[i]}`;
                topicBtn.onclick = () => {
                    playClickSound();
                    currentTopicIndex = i;
                    loadTopicContent(i);
                };
                topicsList.appendChild(topicBtn);
            }
        }

        // Load videos for selected topic
        function loadTopicContent(topicIndex) {
            document.getElementById("current-topic-title").textContent = `Topic ${topicIndex + 1} Videos`;
            const statusElement = document.getElementById("video-status");
            const videoContainer = document.getElementById("video-container");
            const teacherInfoElement = document.getElementById("teacher-info");

            statusElement.textContent = "Loading videos...";
            statusElement.className = "status-message loading";
            videoContainer.innerHTML = "";
            teacherInfoElement.innerHTML = "";

            fetch(`/get_topic_videos?topic_index=${topicIndex}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.videos && data.videos.length > 0) {
                        statusElement.textContent = "";
                        statusElement.className = "status-message";

                        allVideos = data.videos;

                        // Show teacher info
                        const teachers = [...new Set(data.videos.map(video => video.teacher_name))];
                        teacherInfoElement.innerHTML =
                            `<p>Videos uploaded by: <strong>${teachers.join(", ")}</strong></p>`;

                        displayFilteredVideos();

                        // Add Start Exercises button
                        const startExercisesBtn = document.createElement("button");
                        startExercisesBtn.textContent = "Start Exercises";
                        startExercisesBtn.className = "start-exercises";
                        startExercisesBtn.onclick = () => {
                            playClickSound();
                            loadExercises(topicIndex);
                        };
                        videoContainer.appendChild(startExercisesBtn);

                    } else {
                        statusElement.textContent = "No videos available for this topic yet.";
                        statusElement.className = "status-message info";
                    }
                })
                .catch(error => {
                    console.error("Error loading videos:", error);
                    statusElement.textContent = `Error loading videos: ${error.message}`;
                    statusElement.className = "status-message error";
                });
        }

        function displayFilteredVideos() {
            const selectedTeacherId = document.getElementById("teacher-filter").value;
            const searchTerm = document.getElementById("search-input").value.toLowerCase();

            const filteredVideos = allVideos.filter(video => {
                const matchesTeacher = !selectedTeacherId || video.user_id == selectedTeacherId;
                const matchesSearch = !searchTerm ||
                    video.file_path.toLowerCase().includes(searchTerm) ||
                    video.teacher_name.toLowerCase().includes(searchTerm);
                return matchesTeacher && matchesSearch;
            });

            const videoContainer = document.getElementById("video-container");
            videoContainer.innerHTML = ""; // Clear existing content

            filteredVideos.forEach((video, index) => {
                const videoWrapper = document.createElement("div");
                videoWrapper.className = "video-wrapper";

                const videoElement = document.createElement("video");
                videoElement.controls = true;
                videoElement.src = video.file_path;
                videoElement.className = "topic-video";

                const videoTitle = document.createElement("p");
                videoTitle.textContent = extractTopicName(video.file_path) || `Video ${index + 1}`;
                videoTitle.className = "video-title";

                const teacherLabel = document.createElement("p");
                teacherLabel.textContent = `Uploaded by: ${video.teacher_name}`;
                teacherLabel.className = "teacher-label";

                videoWrapper.appendChild(videoTitle);
                videoWrapper.appendChild(teacherLabel);
                videoWrapper.appendChild(videoElement);
                videoContainer.appendChild(videoWrapper);
            });

            // Re-add Start Exercises button
            const startExercisesBtn = document.createElement("button");
            startExercisesBtn.textContent = "Start Exercises";
            startExercisesBtn.className = "start-exercises";
            startExercisesBtn.onclick = () => {
                playClickSound();
                loadExercises(currentTopicIndex);
            };
            videoContainer.appendChild(startExercisesBtn);
        }

        // Load exercises for the current topic
        function loadExercises(topicIndex) {
            document.getElementById("video-section").classList.add("hidden");
            document.getElementById("exercise-section").classList.remove("hidden");
            document.getElementById("exercise-topic-title").textContent = `Topic ${topicIndex + 1} Exercises`;
            const statusElement = document.getElementById("exercise-status");
            statusElement.textContent = "Loading exercises...";
            statusElement.className = "status-message loading";

            fetch(`/get_topic_exercises?topic_index=${topicIndex}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.exercises && data.exercises.length > 0) {
                        statusElement.textContent = "";
                        statusElement.className = "status-message";

                        allExercises = data.exercises;
                        displayFilteredExercises();

                        if (musicEnabled) {
                            backgroundMusic.play().catch(e => console.log("Play prevented:", e));
                        }
                    } else {
                        statusElement.textContent = "No exercises available for this topic yet.";
                        statusElement.className = "status-message info";
                    }
                })
                .catch(error => {
                    console.error("Error loading exercises:", error);
                    statusElement.textContent = `Error loading exercises: ${error.message}`;
                    statusElement.className = "status-message error";
                });
        }

        function displayFilteredExercises() {
            const selectedTeacherId = document.getElementById("teacher-filter").value;
            const searchTerm = document.getElementById("search-input").value.toLowerCase();

            const filteredExercises = allExercises.filter(exercise => {
                const matchesTeacher = !selectedTeacherId || exercise.user_id == selectedTeacherId;
                const matchesSearch = !searchTerm ||
                    exercise.question?.toLowerCase().includes(searchTerm) ||
                    exercise.teacher_name?.toLowerCase().includes(searchTerm);
                return matchesTeacher && matchesSearch;
            });

            exercises = filteredExercises;
            currentExerciseIndex = 0;
            completedExercises = [];
            updateProgress();

            if (exercises.length > 0) {
                displayExercise(exercises[0]);
            } else {
                const container = document.getElementById("current-exercise");
                container.innerHTML = "<p>No matching exercises found.</p>";
            }
        }

        // Display the current exercise
        function displayExercise(exercise) {
            const exerciseContainer = document.getElementById("current-exercise");
            exerciseContainer.innerHTML = "";

            const teacherLabel = document.createElement("p");
            teacherLabel.className = "exercise-teacher";
            teacherLabel.textContent = `Created by: ${exercise.teacher_name || "Unknown"}`;
            exerciseContainer.appendChild(teacherLabel);

            const questionDiv = document.createElement("div");
            questionDiv.className = "exercise-question";

            if (exercise.question_image) {
                const img = document.createElement("img");
                img.src = exercise.question_image;
                img.alt = "Question Image";
                questionDiv.appendChild(img);
            }

            if (exercise.question) {
                const text = document.createElement("p");
                text.textContent = exercise.question;
                questionDiv.appendChild(text);
            }

            exerciseContainer.appendChild(questionDiv);

            const optionsDiv = document.createElement("div");
            optionsDiv.className = "exercise-options";

            exercise.options.forEach((option, index) => {
                const btn = document.createElement("button");
                btn.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                btn.onclick = () => checkAnswer(index, exercise.correct_option);
                optionsDiv.appendChild(btn);
            });

            exerciseContainer.appendChild(optionsDiv);
            document.getElementById("next-exercise-btn").classList.add("hidden");
            document.getElementById("feedback-message").textContent = "";
        }

        // Check answer
        function checkAnswer(selectedIndex, correctIndex) {
            playClickSound();
            const feedback = document.getElementById("feedback-message");
            if (selectedIndex === correctIndex) {
                feedback.textContent = positiveFeedback[Math.floor(Math.random() * positiveFeedback.length)];
                feedback.className = "feedback-message correct";
                if (!completedExercises.includes(currentExerciseIndex)) {
                    completedExercises.push(currentExerciseIndex);
                    updateProgress();
                }
                document.getElementById("next-exercise-btn").classList.remove("hidden");
            } else {
                feedback.textContent = negativeFeedback[Math.floor(Math.random() * negativeFeedback.length)];
                feedback.className = "feedback-message incorrect";
            }
        }

        // Load next exercise
        function loadNextExercise() {
            if (completedExercises.includes(currentExerciseIndex)) {
                currentExerciseIndex++;
                if (currentExerciseIndex < exercises.length) {
                    displayExercise(exercises[currentExerciseIndex]);
                } else {
                    const container = document.getElementById("current-exercise");
                    container.innerHTML = `
                        <p class='completion-message'>You've completed all exercises for this topic!</p>
                    `;
                    document.getElementById("next-exercise-btn").classList.add("hidden");
                }
            }
        }

        // Update progress bar
        function updateProgress() {
            document.getElementById("completed-count").textContent = completedExercises.length;
            document.getElementById("total-count").textContent = exercises.length;
        }

        // Go back to videos
        function backToVideos() {
            document.getElementById("exercise-section").classList.add("hidden");
            document.getElementById("video-section").classList.remove("hidden");
            displayFilteredVideos();
        }

        // Play click sound
        function playClickSound() {
            const sound = document.getElementById("buttonClickSound");
            sound.currentTime = 0;
            sound.play();
        }

        // Logout
        function logoutAndPlaySound() {
            playClickSound();
            setTimeout(() => window.location.href = '/', 300);
        }

        // Helper: Extract topic name from file path
        function extractTopicName(filePath) {
            const filename = filePath.split('/').pop().split('\\').pop();
            const match = filename.match(/Topic_\d+_(.+?)\.\w+$/);
            return match && match[1] ? match[1].replace(/_/g, ' ') : null;
        }

        // Load teachers into filter dropdown
        function loadTeachers() {
            fetch("/get_all_teachers")
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById("teacher-filter");
                    data.teachers.forEach(teacher => {
                        const opt = document.createElement("option");
                        opt.value = teacher.user_id;
                        opt.textContent = teacher.name;
                        select.appendChild(opt);
                    });
                })
                .catch(err => console.error("Error fetching teachers:", err));

            // Add event listeners
            document.getElementById("teacher-filter").addEventListener("change", () => {
                displayFilteredVideos();
                if (!document.getElementById("exercise-section").classList.contains("hidden")) {
                    displayFilteredExercises();
                }
            });

            document.getElementById("search-input").addEventListener("input", () => {
                displayFilteredVideos();
                if (!document.getElementById("exercise-section").classList.contains("hidden")) {
                    displayFilteredExercises();
                }
            });
        }
    </script>
</body>
</html>
